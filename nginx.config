server {
    listen 80;
    server_name growthapp.dev www.growthapp.dev;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name growthapp.dev www.growthapp.dev;

    ssl_certificate     /etc/letsencrypt/live/growthapp.dev/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/growthapp.dev/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    root /var/www/growthapp;
    index index.html;

    # --- CORS global ---
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, Cookie" always;

    if ($request_method = OPTIONS) {
        return 204;
    }

    # --- Injection dynamique de env.js ---
    location /env.js {
        default_type application/javascript;
        return 200 '
            window._env_ = {
                BASE_URL: "https://growthapp.dev",
                MAIN_URL: "https://growthapp.dev/main/api",
                CHATGPT_URL: "https://growthapp.dev/chatgpt/api",
                MESSAGE_URL: "https://growthapp.dev/message/api"
            };
        ';
    }

    # --- Proxys API ---
    location /main/api/ {
        proxy_pass http://127.0.0.1:3001/;
    }

    location /chatgpt/api/ {
        proxy_pass http://127.0.0.1:3002/;
    }

    location /message/api/ {
        proxy_pass http://127.0.0.1:3003/;
    }

    # --- Routes SPA (frontend) ---
    location /main {
        try_files $uri /index.html;
    }

    location /chatgpt {
        try_files $uri /index.html;
    }

    location /message {
        try_files $uri /index.html;
    }

    # --- Frontend global ---
    location / {
        try_files $uri /index.html;
    }
}
